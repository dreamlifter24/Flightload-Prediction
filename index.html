<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Load Prediction</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden; /* Prevent overall scroll */
    }
    #container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #tabsContainer {
      width: 250px;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      background: #f9f9f9;
      flex-shrink: 0;
      transition: width 0.3s ease;
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
      padding-top: 48px; /* space for toggle button */
      position: relative;
    }
    #rightPanel {
      flex-grow: 1;
      padding: 20px;
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      transition: margin-left 0.3s ease;
      box-sizing: border-box;
    }
    #rightPanel.fullWidth {
      margin-left: 0;
    }
    #hideSidebarBtn {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 36px;
      height: 36px;
      z-index: 1000;
      background: #007bff;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 24px;
      line-height: 30px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      user-select: none;
    }
    #tabsHeader {
      padding: 0 10px 5px 10px;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 3;
      border-bottom: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #homeTab {
      margin: 0;
      background: #dae0e5;
      font-weight: bold;
      cursor: default;
      border-bottom: none;
      padding: 12px 15px;
      text-align: left;
      user-select: none;
      border: 1px solid #ccc;
      border-bottom: none;
      z-index: 4;
    }
    #addJourneyBtn {
      margin: 10px 10px 0 10px;
      padding: 10px 15px;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      font-size: 14px;
      user-select: none;
      text-align: left;
      z-index: 4;
    }
    #tabListWrapper {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 10px;
    }
    #tabList {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tabButton {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 10px 15px;
      cursor: pointer;
      border: none;
      border-bottom: 1px solid #ddd;
      background: none;
      text-align: left;
      font-size: 14px;
      box-sizing: border-box;
    }
    .tabButton.active {
      background: #e9ecef;
      font-weight: bold;
    }
    .tabButton .closeBtn {
      font-weight: bold;
      color: #888;
      cursor: pointer;
      user-select: none;
      padding-left: 10px;
    }
    .tabButton .closeBtn:hover {
      color: red;
    }
    h2 {
      margin-top: 0;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"] {
      padding: 5px;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
    }
    input[readonly] {
      background: #e9ecef;
      border: 1px solid #ccc;
      cursor: default;
    }
    select.editDropdown {
      width: 100%;
      max-width: 100px;
      padding: 2px 5px;
    }
    button.action {
      margin-top: 10px;
      padding: 6px 14px;
      cursor: pointer;
      margin-right: 10px;
    }
    table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: center;
      word-wrap: break-word;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
    }
    td[contenteditable="true"] {
      background-color: #fffbe6;
      cursor: text;
    }
    tr.highlight {
      background-color: #d4edda;
    }
    #predictionResult {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.1em;
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    #analysisProcedure {
      margin-top: 15px;
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      padding: 10px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 320px;
      overflow-y: auto;
      word-wrap: break-word;
    }
    #homePage {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      font-size: 1.2em;
      color: #444;
    }
  </style>
</head>
<body>
  <button id="hideSidebarBtn" title="Toggle Navigation">&#9776;</button>
  <div id="container">
    <div id="tabsContainer">
      <div id="tabsHeader">
        <button id="homeTab" class="tabButton active" onclick="selectHomeTab()">Home Page</button>
        <button id="addJourneyBtn" onclick="addTabPrompt()">+ Add New Journey</button>
      </div>
      <div id="tabListWrapper">
        <div id="tabList"></div>
      </div>
    </div>
    <div id="rightPanel">
      <div id="homePage">
        <h2>Welcome to Flight Journeys Prediction Tool</h2>
        <p>This tool lets you manage multiple flight journeys, add flights, and predict the earliest flight you can board.</p>
        <p><strong>How to use:</strong></p>
        <ol style="max-width: 600px; margin: auto; text-align: left;">
          <li>Click <em>+ Add New Journey</em> to create a departure, arrival, and date for the journey.</li>
          <li>Select a journey tab to input flights for that route and date.</li>
          <li>Enter flight details and add flights to the journey.</li>
          <li>Click <em>Execute Prediction</em> to analyze flights and find your earliest flight.</li>
          <li>Manage journeys by selecting or deleting tabs on the left.</li>
        </ol>
      </div>
      <div id="flightInputSection" style="display:none;">
        <h2>Flight Details Input</h2>
        <form id="flightForm" onsubmit="return false;">
          <label for="flightNumber">Flight Number:</label>
          <input type="text" id="flightNumber" placeholder="e.g. AB1234" required />

          <label for="departure">Departure Destination:</label>
          <input type="text" id="departure" readonly />

          <label for="arrival">Arrival Destination:</label>
          <input type="text" id="arrival" readonly />

          <label for="totalSeatsAvailable">Total Seats Available:</label>
          <input type="number" id="totalSeatsAvailable" min="0" placeholder="e.g. 150" required />

          <label for="totalSeatsBooked">Total Seats Booked:</label>
          <input type="number" id="totalSeatsBooked" min="0" placeholder="e.g. 120" required />

          <label for="queueInput">Number of People Queueing Before You:</label>
          <input type="number" id="queueInput" min="0" placeholder="e.g. 3" required />

          <label>
            <input type="checkbox" id="targetFlight" />
            Is this your targeted flight?
          </label>

          <button class="action" onclick="addFlightToCurrentJourney()">Add Flight</button>
          <button class="action" onclick="clearCurrentInputs()">Clear Inputs</button>
          <button class="action" onclick="executePrediction()">Execute Prediction</button>
        </form>

        <table id="flightsTable" style="display:none;">
          <thead>
            <tr>
              <th>Flight Number</th>
              <th>Total Seats Available</th>
              <th>Total Seats Booked</th>
              <th>Seats Remaining</th>
              <th>People Queueing Before</th>
              <th>Targeted Flight</th>
              <th>Staff Rolled to Next Flight</th>
            </tr>
          </thead>
          <tbody id="flightsBody"></tbody>
        </table>

        <div id="predictionResult"></div>
        <pre id="analysisProcedure"></pre>
      </div>
    </div>
  </div>

<script>
  const journeys = {};
  let currentJourneyKey = null;
  const tabsContainer = document.getElementById('tabsContainer');
  const rightPanel = document.getElementById('rightPanel');
  const hideSidebarBtn = document.getElementById('hideSidebarBtn');

  hideSidebarBtn.addEventListener('click', () => {
    if (tabsContainer.style.width === '0px' || tabsContainer.style.width === '0') {
      tabsContainer.style.width = '250px';
      rightPanel.classList.remove('fullWidth');
    } else {
      tabsContainer.style.width = '0';
      rightPanel.classList.add('fullWidth');
    }
  });

  function formatDate(d) {
    const day = ('0' + d.getDate()).slice(-2);
    const month = ('0' + (d.getMonth() + 1)).slice(-2);
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function sanitizeKey(dep, arr, date) {
    return dep.trim().toLowerCase() + '→' + arr.trim().toLowerCase() + '→' + date;
  }

  function addTabPrompt() {
    const dep = prompt("Enter Departure Destination for the new journey:");
    if (!dep) return;
    const arr = prompt("Enter Arrival Destination for the new journey:");
    if (!arr) return;

    // Use date picker in a temporary modal prompt
    const date = promptDate();
    if (!date) return;

    const dateStr = formatDate(date);
    const key = sanitizeKey(dep, arr, dateStr);
    if (journeys[key]) {
      alert("Journey already exists.");
      return;
    }
    journeys[key] = {
      departure: dep.trim(),
      arrival: arr.trim(),
      date: dateStr,
      flights: []
    };
    addTabButton(key);
    selectJourney(key);
  }

  // Create a modal date picker prompt
  function promptDate() {
    return new Promise(resolve => {
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = 0; modal.style.left = 0; modal.style.right = 0; modal.style.bottom = 0;
      modal.style.background = 'rgba(0,0,0,0.4)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = 10000;

      const container = document.createElement('div');
      container.style.background = '#fff';
      container.style.padding = '20px';
      container.style.borderRadius = '8px';
      container.style.textAlign = 'center';
      container.style.minWidth = '250px';

      const label = document.createElement('label');
      label.textContent = 'Select Journey Date:';
      label.style.display = 'block';
      label.style.marginBottom = '8px';

      const input = document.createElement('input');
      input.type = 'date';
      input.style.width = '100%';
      input.style.fontSize = '16px';
      input.valueAsDate = new Date();

      const btnConfirm = document.createElement('button');
      btnConfirm.textContent = 'OK';
      btnConfirm.style.marginTop = '15px';
      btnConfirm.style.padding = '6px 12px';
      btnConfirm.onclick = () => {
        if (!input.value) {
          alert('Please select a date.');
          return;
        }
        document.body.removeChild(modal);
        resolve(new Date(input.value));
      };

      const btnCancel = document.createElement('button');
      btnCancel.textContent = 'Cancel';
      btnCancel.style.marginLeft = '10px';
      btnCancel.style.padding = '6px 12px';
      btnCancel.onclick = () => {
        document.body.removeChild(modal);
        resolve(null);
      };

      container.appendChild(label);
      container.appendChild(input);
      container.appendChild(btnConfirm);
      container.appendChild(btnCancel);
      modal.appendChild(container);
      document.body.appendChild(modal);
    });
  }

  async function addTabPrompt() {
    const dep = prompt("Enter Departure Destination for the new journey:");
    if (!dep) return;
    const arr = prompt("Enter Arrival Destination for the new journey:");
    if (!arr) return;

    // Use date picker in a modal prompt
    const date = await promptDate();
    if (!date) return; // user cancelled

    const dateStr = formatDate(date);
    const key = sanitizeKey(dep, arr, dateStr);
    if (journeys[key]) {
      alert("Journey already exists.");
      return;
    }
    journeys[key] = {
      departure: dep.trim(),
      arrival: arr.trim(),
      date: dateStr,
      flights: []
    };
    addTabButton(key);
    selectJourney(key);
  }

  function addTabButton(key) {
    const tabList = document.getElementById('tabList');
    const btn = document.createElement('button');
    btn.className = 'tabButton';
    btn.dataset.key = key;

    const spanText = document.createElement('span');
    const journey = journeys[key];
    spanText.textContent = `${journey.departure} → ${journey.arrival} (${journey.date})`;
    spanText.style.flexGrow = '1';
    btn.appendChild(spanText);

    const closeBtn = document.createElement('span');
    closeBtn.className = 'closeBtn';
    closeBtn.textContent = '×';
    closeBtn.title = "Delete this journey";
    closeBtn.onclick = (e) => {
      e.stopPropagation();
      deleteJourney(key);
    };
    btn.appendChild(closeBtn);

    btn.onclick = () => selectJourney(key);
    tabList.appendChild(btn);
  }

  function deleteJourney(key) {
    if (!journeys[key]) return;
    if (confirm(`Are you sure you want to delete journey "${journeys[key].departure} → ${journeys[key].arrival} (${journeys[key].date})"?`)) {
      delete journeys[key];
      const tabList = document.getElementById('tabList');
      const btn = tabList.querySelector(`.tabButton[data-key="${key}"]`);
      if (btn) tabList.removeChild(btn);

      if (currentJourneyKey === key) {
        const keys = Object.keys(journeys);
        if (keys.length > 0) {
          selectJourney(keys[0]);
        } else {
          selectHomeTab();
        }
      }
    }
  }

  function selectHomeTab() {
    currentJourneyKey = null;
    document.getElementById('homeTab').classList.add('active');
    document.querySelectorAll('#tabList .tabButton').forEach(btn => btn.classList.remove('active'));
    document.getElementById('homePage').style.display = 'block';
    document.getElementById('flightInputSection').style.display = 'none';
    clearRightPanel();
  }

  function selectJourney(key) {
    currentJourneyKey = key;
    document.getElementById('homeTab').classList.remove('active');
    document.querySelectorAll('#tabList .tabButton').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.key === key);
    });
    const journey = journeys[key];
    document.getElementById('departure').value = journey.departure;
    document.getElementById('arrival').value = journey.arrival;

    document.getElementById('homePage').style.display = 'none';
    document.getElementById('flightInputSection').style.display = 'block';

    populateFlightsTable();
    clearPrediction();
    clearCurrentInputs();
  }

  function clearRightPanel() {
    document.getElementById('departure').value = '';
    document.getElementById('arrival').value = '';
    document.getElementById('flightsBody').innerHTML = '';
    document.getElementById('flightsTable').style.display = 'none';
    clearPrediction();
    clearCurrentInputs();
  }

  function populateFlightsTable() {
    const flightsBody = document.getElementById('flightsBody');
    const flightsTable = document.getElementById('flightsTable');
    flightsBody.innerHTML = '';
    if (!currentJourneyKey || !journeys[currentJourneyKey] || journeys[currentJourneyKey].flights.length === 0) {
      flightsTable.style.display = 'none';
      return;
    }
    flightsTable.style.display = 'table';

    journeys[currentJourneyKey].flights.forEach((flight, i) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true">${flight.flightNumber}</td>
        <td contenteditable="true">${flight.totalSeatsAvailable}</td>
        <td contenteditable="true">${flight.totalSeatsBooked}</td>
        <td>${flight.seatsRemaining ?? (flight.totalSeatsAvailable - flight.totalSeatsBooked)}</td>
        <td contenteditable="true">${flight.peopleQueueingBefore}</td>
        <td>
          <select class="editDropdown">
            <option value="Yes" ${flight.isTargeted ? "selected" : ""}>Yes</option>
            <option value="No" ${!flight.isTargeted ? "selected" : ""}>No</option>
          </select>
        </td>
        <td>${flight.staffRolled || 0}</td>
      `;
      flightsBody.appendChild(row);
    });
  }

  function clearCurrentInputs() {
    document.getElementById('flightNumber').value = '';
    document.getElementById('totalSeatsAvailable').value = '';
    document.getElementById('totalSeatsBooked').value = '';
    document.getElementById('queueInput').value = '';
    document.getElementById('targetFlight').checked = false;
  }

  function addFlightToCurrentJourney() {
    if (!currentJourneyKey) {
      alert("Please add and select a journey tab first (departure and arrival).");
      return;
    }
    const flightNumber = document.getElementById('flightNumber').value.trim();
    const totalSeatsAvailable = parseInt(document.getElementById('totalSeatsAvailable').value.trim());
    const totalSeatsBooked = parseInt(document.getElementById('totalSeatsBooked').value.trim());
    const queueNumber = parseInt(document.getElementById('queueInput').value.trim());
    const targeted = document.getElementById('targetFlight').checked;

    if (!flightNumber) {
      alert('Please enter the flight number.');
      return;
    }
    if (isNaN(totalSeatsAvailable) || totalSeatsAvailable < 0) {
      alert('Please enter a valid non-negative number for Total Seats Available.');
      return;
    }
    if (isNaN(totalSeatsBooked) || totalSeatsBooked < 0) {
      alert('Please enter a valid non-negative number for Total Seats Booked.');
      return;
    }
    if (isNaN(queueNumber) || queueNumber < 0) {
      alert('Please enter a valid non-negative number for the number of people queueing before you.');
      return;
    }

    journeys[currentJourneyKey].flights.push({
      flightNumber,
      totalSeatsAvailable,
      totalSeatsBooked,
      seatsRemaining: totalSeatsAvailable - totalSeatsBooked,
      peopleQueueingBefore: queueNumber,
      isTargeted: targeted,
      staffRolled: 0
    });
    populateFlightsTable();
    clearCurrentInputs();
    clearPrediction();
  }

  function clearPrediction() {
    const rows = document.querySelectorAll('#flightsBody tr');
    rows.forEach(row => {
      row.classList.remove('highlight');
    });
    const pred = document.getElementById('predictionResult');
    pred.style.display = 'none';
    pred.textContent = '';
    const analysis = document.getElementById('analysisProcedure');
    analysis.style.display = 'none';
    analysis.textContent = '';
  }

  function executePrediction() {
    if (!currentJourneyKey || !journeys[currentJourneyKey]) {
      alert("Please select a journey before executing prediction.");
      return;
    }
    clearPrediction();

    const flights = journeys[currentJourneyKey].flights;

    const rows = document.querySelectorAll('#flightsBody tr');
    rows.forEach((row, i) => {
      let cells = row.cells;
      flights[i].flightNumber = cells[0].textContent.trim();
      flights[i].totalSeatsAvailable = parseInt(cells[1].textContent) || 0;
      flights[i].totalSeatsBooked = parseInt(cells[2].textContent) || 0;
      flights[i].seatsRemaining = flights[i].totalSeatsAvailable - flights[i].totalSeatsBooked;
      flights[i].peopleQueueingBefore = parseInt(cells[4].textContent) || 0;
      const select = cells[5].querySelector('select.editDropdown');
      flights[i].isTargeted = select && select.value.toLowerCase() === 'yes';
      flights[i].staffRolled = 0;
      cells[3].textContent = flights[i].seatsRemaining;
      cells[6].textContent = 0;
      row.classList.remove('highlight');
    });

    let peopleToTransfer = 0;
    let earliestFlightIndex = -1;
    let analysisLog = `Prediction Analysis Procedure for journey ${journeys[currentJourneyKey].departure} → ${journeys[currentJourneyKey].arrival} (${journeys[currentJourneyKey].date}):\n\n`;

    for(let i = 0; i < flights.length; i++) {
      const flight = flights[i];
      let queueingBefore = flight.peopleQueueingBefore + peopleToTransfer;
      analysisLog += `Flight ${i + 1} (${flight.flightNumber}):\n`;
      analysisLog += `  Seats Remaining: ${flight.seatsRemaining}\n`;
      analysisLog += `  People Queueing Before (including transferred): ${queueingBefore}\n`;

      if (flight.seatsRemaining > queueingBefore) {
        peopleToTransfer = 0;
        analysisLog += `  Decision: Seats remaining > people queueing, no transfer needed.\n`;
      } else {
        peopleToTransfer = queueingBefore - flight.seatsRemaining;
        analysisLog += `  Decision: Seats remaining ≤ people queueing, transferring ${peopleToTransfer} people to next flight.\n`;
      }
      flight.staffRolled = peopleToTransfer;
      rows[i].cells[6].textContent = peopleToTransfer;

      if (peopleToTransfer === 0 && earliestFlightIndex === -1) {
        earliestFlightIndex = i;
        analysisLog += `  Conclusion: Earliest flight you can get on found: Flight ${i + 1} (${flight.flightNumber}).\n`;
        break;
      }
      analysisLog += '\n';
    }

    const predictionResult = document.getElementById('predictionResult');
    const analysisDisplay = document.getElementById('analysisProcedure');
    if (earliestFlightIndex === -1) {
      predictionResult.textContent = 'No flight can accommodate you based on the provided data.';
    } else {
      rows[earliestFlightIndex].classList.add('highlight');
      predictionResult.textContent = `Earliest flight you can get on is: ${flights[earliestFlightIndex].flightNumber}`;
    }
    predictionResult.style.display = 'block';
    analysisDisplay.textContent = analysisLog;
    analysisDisplay.style.display = 'block';
  }

  // On load, show the Home tab content only
  window.onload = () => {
    selectHomeTab();
  };
</script>
</body>
</html>
